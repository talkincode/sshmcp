#!/bin/bash
# Pre-push hook to run comprehensive checks before pushing

set -e

echo "ğŸš€ Running pre-push checks..."
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_status() {
    echo -e "${BLUE}âœ${NC} $1"
}

print_success() {
    echo -e "${GREEN}âœ“${NC} $1"
}

print_error() {
    echo -e "${RED}âœ—${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}âš ${NC} $1"
}

# 1. Run all tests with coverage
print_status "Running tests with coverage..."
if ! go test -v -race -coverprofile=coverage.out -covermode=atomic ./...; then
    print_error "Tests failed"
    exit 1
fi
print_success "All tests passed with race detection"
echo ""

# 2. Check test coverage
print_status "Checking test coverage..."
coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
if (( $(echo "$coverage < 50" | bc -l) )); then
    print_warning "Test coverage is below 50% (current: ${coverage}%)"
    print_warning "Please consider adding more tests in future commits"
    # Don't fail on low coverage for now - just warn
    # exit 1
else
    print_success "Test coverage: ${coverage}%"
fi
echo ""

# 3. Build for all platforms
print_status "Building for all platforms..."
if ! make build-all > /dev/null 2>&1; then
    print_error "Cross-platform build failed"
    exit 1
fi
print_success "All platform builds successful"
echo ""

# 4. Clean up
rm -f coverage.out

echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}âœ“ All pre-push checks passed!${NC}"
echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

exit 0
