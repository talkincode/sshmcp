#!/bin/bash
# Commit message hook to enforce conventional commit format
# Format: <type>(<scope>): <subject>
# Types: feat, fix, docs, style, refactor, test, chore

set -e

commit_msg_file=$1
commit_msg=$(cat "$commit_msg_file")

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Skip merge commits
if echo "$commit_msg" | grep -qE "^Merge "; then
    exit 0
fi

# Conventional commit pattern
pattern='^(feat|fix|docs|style|refactor|perf|test|chore|build|ci|revert)(\(.+\))?: .{1,72}'

if ! echo "$commit_msg" | grep -qE "$pattern"; then
    echo -e "${RED}✗ Invalid commit message format${NC}"
    echo ""
    echo "Commit message should follow conventional commits format:"
    echo ""
    echo -e "${GREEN}Format:${NC}"
    echo "  <type>(<scope>): <subject>"
    echo ""
    echo -e "${GREEN}Types:${NC}"
    echo "  feat:     New feature"
    echo "  fix:      Bug fix"
    echo "  docs:     Documentation update"
    echo "  style:    Code formatting"
    echo "  refactor: Refactoring"
    echo "  perf:     Performance improvement"
    echo "  test:     Testing related"
    echo "  chore:    Build/toolchain"
    echo "  build:    Build system"
    echo "  ci:       CI configuration"
    echo ""
    echo -e "${GREEN}Examples:${NC}"
    echo "  feat: add proxy support"
    echo "  feat(ssh): add HTTP proxy support"
    echo "  fix: fix connection pool memory leak"
    echo "  fix(mcp): fix tool invocation error"
    echo "  docs: update README installation instructions"
    echo ""
    echo -e "${YELLOW}Your commit message:${NC}"
    echo "$commit_msg"
    echo ""
    echo -e "${YELLOW}Tip:${NC} Use 'git commit --amend' to fix your commit message"
    exit 1
fi

echo -e "${GREEN}✓ Commit message format valid${NC}"
exit 0
