name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Get version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build binaries
        run: |
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p dist

          # å®šä¹‰æ„å»ºå‡½æ•°
          build() {
            local os=$1
            local arch=$2
            local output="dist/sshx-${os}-${arch}"

            if [ "$os" = "windows" ]; then
              output="${output}.exe"
            fi

            echo "Building for $os/$arch..."
            GOOS=$os GOARCH=$arch CGO_ENABLED=0 go build \
              -ldflags="-s -w -X main.Version=${{ steps.get_version.outputs.VERSION }}" \
              -o "$output" \
              ./cmd/sshx

            # å‹ç¼©äºŒè¿›åˆ¶æ–‡ä»¶
            if [ "$os" = "windows" ]; then
              zip "dist/sshx-${os}-${arch}.zip" "$output"
              rm "$output"
            else
              tar czf "dist/sshx-${os}-${arch}.tar.gz" -C dist "$(basename $output)"
              rm "$output"
            fi
          }

          # æ„å»ºæ‰€æœ‰å¹³å°
          build linux amd64
          build linux arm64
          build darwin amd64
          build darwin arm64
          build windows amd64

      - name: Generate checksums
        run: |
          cd dist
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## SSH & SFTP Remote Tool with MCP Support

            ### ğŸš€ ä¸€é”®å®‰è£… (æ¨è)

            #### Linux / macOS
            ```bash
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/install.sh | bash
            ```

            #### Windows (PowerShell ç®¡ç†å‘˜æƒé™)
            ```powershell
            irm https://raw.githubusercontent.com/${{ github.repository }}/main/install.ps1 | iex
            ```

            ğŸ“– **è¯¦ç»†å®‰è£…æ–‡æ¡£**: [INSTALL.md](https://github.com/${{ github.repository }}/blob/main/INSTALL.md)

            ---

            ### ğŸ“¦ æ‰‹åŠ¨ä¸‹è½½

            è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š

            - **Linux (x86_64)**: `sshx-linux-amd64.tar.gz`
            - **Linux (ARM64)**: `sshx-linux-arm64.tar.gz`
            - **macOS (Intel)**: `sshx-darwin-amd64.tar.gz`
            - **macOS (Apple Silicon)**: `sshx-darwin-arm64.tar.gz`
            - **Windows (x86_64)**: `sshx-windows-amd64.zip`

            ### ğŸ“ æ‰‹åŠ¨å®‰è£…æ–¹æ³•

            #### Linux / macOS
            ```bash
            # ä¸‹è½½å¹¶è§£å‹
            tar xzf sshx-<platform>-<arch>.tar.gz

            # ç§»åŠ¨åˆ°ç³»ç»Ÿè·¯å¾„
            sudo mv sshx /usr/local/bin/

            # èµ‹äºˆæ‰§è¡Œæƒé™
            sudo chmod +x /usr/local/bin/sshx

            # éªŒè¯å®‰è£…
            sshx --help
            ```

            #### Windows
            ```powershell
            # è§£å‹ zip æ–‡ä»¶
            # å°† sshx.exe æ·»åŠ åˆ°ç³»ç»Ÿ PATH
            # æˆ–ç›´æ¥åœ¨è§£å‹ç›®å½•ä¸‹ä½¿ç”¨
            ```

            ### åŠŸèƒ½ç‰¹æ€§

            - âœ… SSH è¿œç¨‹å‘½ä»¤æ‰§è¡Œ
            - âœ… SFTP æ–‡ä»¶ä¼ è¾“ï¼ˆä¸Šä¼ /ä¸‹è½½/åˆ—è¡¨/åˆ›å»ºç›®å½•/åˆ é™¤ï¼‰
            - âœ… è·¨å¹³å°å¯†ç ç®¡ç†ï¼ˆç³»ç»Ÿ Keyringï¼‰
            - âœ… å‘½ä»¤å®‰å…¨æ£€æŸ¥ï¼ˆé˜²æ­¢å±é™©æ“ä½œï¼‰
            - âœ… MCP (Model Context Protocol) æ”¯æŒ
            - âœ… Sudo å¯†ç è‡ªåŠ¨å¡«å……

            ### æ ¡éªŒå’Œ

            è¯·ä½¿ç”¨ `checksums.txt` éªŒè¯ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§ï¼š
            ```bash
            sha256sum -c checksums.txt
            ```

            ### æ›´æ–°æ—¥å¿—

            æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚

          files: |
            dist/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: dist/*
          retention-days: 30
